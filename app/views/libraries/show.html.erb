<% provide(:title, @library.name) %>
<div class="cl-library-detail">
<h1><%= @library.name %></h1>

<div class="cl-address">
<img src="<%= asset_path 'ic_location_gray.png' %>"/>
  <span class="cl-address-text">
    <%= @library.street %>,    
    <%= @library.zip %>
    <%= @library.city %>
  </span>


</div>


<% if @web || @catalog %>
  <div class="cl-links">
    <% if @web %>
      <a href="<%= @web %>" class="btn btn-primary cl-btn">Web knihovny</a>
    <% end %>
    <% if @catalog %>
      <a href="<%= @catalog %>" class="btn btn-info cl-btn">Otevřít katalog</a>
    <% end %>
  </div>
<% end %>




<div class="row" style="padding-bottom:10px;">
  <div class="col-md-9">

  <% unless @library.latitude.nil? || @library.longitude.nil? %>
    <div id="map-canvas" style="width: 100%; height: 400px;"></div>   
  <% end %>        
  </div>

  <div class="col-md-3">
    <div class="cl-right">

    <% if @library.opening_hour %>
      <%= render partial: "opening_hours", locals: {loh: @library.opening_hour} %>
    <% else %>
    <% if @library.phones.present? %>
      <div class="cl-row">
        <img class="cl-icon" src="<%= asset_path 'ic_phone.png' %>"/>
          <div class="cl-text"><%= @library.phones.order(:id)[0].phone %></div>
        </div>
      <% end %>

      <% if @library.emails.present? %>
        <div class="cl-row">
          <img class="cl-icon" src="<%= asset_path 'ic_email2.png' %>"/>
          <div class="cl-text"><%= @library.emails.order(:id)[0].email %></div>
        </div>
      <% end %>    

      <% if @library.people.present? %>              
        <div class="cl-row">
          <img class="cl-icon" src="<%= asset_path 'ic_person2.png' %>"/>
          <div class="cl-text">
            <% person = @library.people.order(:id)[0] %>
            <%= person.degree1 %> <%= person.first_name %> <%= person.last_name %> <%= person.degree2 %>
            <% if person.role %> 
              (<%= person.role %>)
            <% end %>
          </div>                
        </div>
      <% end %>       
    <% end %>

   </div> 



  </div>
</div>



<div>

  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active">
      <a href="#contact" aria-controls="contact" role="tab" data-toggle="tab">Kontakt</a>
    </li>
    <% if @library.branches.present? %>
      <li role="presentation">
        <a href="#branches" aria-controls="branches" role="tab" data-toggle="tab">Pobočky</a>
      </li>
    <% end %>
    <% if @library.services.present? %>
      <li role="presentation">
        <a href="#services" aria-controls="services" role="tab" data-toggle="tab">Služby</a>
      </li>
    <% end %>
    <% if @library.projects.present? %>    
      <li role="presentation">
        <a href="#projects" aria-controls="projects" role="tab" data-toggle="tab">Projekty</a>
      </li>
    <% end %>  
    <li role="presentation">
      <a href="#info" aria-controls="info" role="tab" data-toggle="tab">Podrobné</a>
    </li>    
  </ul>
 <div class="tab-content cl-box">
    <div role="tabpanel" class="tab-pane active" id="contact">
      <div class="cl-contact-wrapper">

        <%if !@library.phones.empty? %>        
          <div class="cl-category cl-border-bottom">      
            <div class="cl-title">Telefon</div>
            <div class="cl-items">
              <% @library.phones.order(:id).each do |phone| %>
                <div class="cl-item"><%= phone.phone %></div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%if !@library.emails.empty? %>
          <div class="cl-category cl-border-bottom">      
            <div class="cl-title">E-mail</div>
            <div class="cl-items">
              <% @library.emails.order(:id).each do |email| %>
                <div class="cl-item">
                  <%= email.email %>
                  <% if email.note %> 
                    (<%= email.note %>)
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%if !@library.faxes.empty? %>
          <div class="cl-category cl-border-bottom">      
            <div class="cl-title">Fax</div>
            <div class="cl-items">
              <% @library.faxes.order(:id).each do |fax| %>
                <div class="cl-item"><%= fax.fax %></div>
              <% end %>
            </div>
          </div>    
        <% end %>

        <%if !@library.people.empty? %>
          <div class="cl-category">      
            <div class="cl-title">Odpovědné osoby</div>
            <div class="cl-items">
              <% @library.people.order(:id).each_with_index do |person, index| %>              
                <% if index > 0 %>
                  <br/>  
                <% end %>
                <div class="cl-person">
                  <div class="cl-person-name">
                    <%= person.degree1 %> <%= person.first_name %> <%= person.last_name %> <%= person.degree2 %>
                    <% if person.role %> 
                      (<%= person.role %>)
                    <% end %>                
                  </div>
                  <% if person.email %> 
                    <div class="cl-person-contact">e-mail: <%= person.email %></div>
                  <% end %>  
                  <% if person.phone %> 
                    <div class="cl-person-contact">tel.: <%= person.phone %></div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>    
        <% end %>

      </div>

    </div>

    <% if @library.branches.present? %>
    <div role="tabpanel" class="tab-pane" id="branches">      
      <div class="cl-contact-wrapper">
        <div class="cl-category">                
          <% @library.branches.each do |branch| %>
            <% if branch.name %>  
              <div class="cl-branch <%= cycle('even', 'odd') %>">            
                <div class="cl-branch-name"><%= branch.name %></div>
                <div class="cl-branch-address"><%= branch.address %></div>
              </div>
            <% end %>
          <% end %>
        </div>    
      </div>
    </div>
    <% end %>


    <% if @library.services.present? %>
      <div role="tabpanel" class="tab-pane" id="services">
        <div class="cl-contact-wrapper">

          <div class="cl-category">      
            <div class="cl-items">
              <% @library.services.each do |service| %>
                <div class="cl-item">
                  <%= service.name %> 
                </div>
              <% end %>
            </div>
          </div>    
        </div>
      </div>
    <% end %>

    <% if @library.services.present? %>
      <div role="tabpanel" class="tab-pane" id="projects">
        <div class="cl-contact-wrapper">
          <div class="cl-category">      
            <div class="cl-items">
              <% @library.projects.each do |project| %>
                <div class="cl-item">
                  <%= project.name %> 
                </div>
              <% end %>
            </div>
          </div>    
        </div>
      </div>    
    <% end %>


    <div role="tabpanel" class="tab-pane" id="info">
      <div class="cl-contact-wrapper">        
        <div class="cl-category">      
          <div class="cl-items">   
            <div class="cl-item" style="padding-bottom:10px;">
              <strong>Popis</strong>
              <div><%= @library.description %></div>
            </div>
            <div class="cl-item"><strong>Typ</strong> <%= @library.context %></div>
            <div class="cl-item"><strong>Kraj</Strong> <%= @library.district %></div>
            <div class="cl-item"><strong>Okres</Strong> <%= @library.town %></div>
            <div class="cl-item"><strong>Sigla</Strong> <%= @library.sigla %></div>
            <div class="cl-item"><strong>Zkratka</Strong> <%= @library.code %></div>
            <div class="cl-item"><strong>IČ</Strong> <%= @library.ico %></div>
            <div class="cl-item"><strong>DIČ</Strong> <%= @library.dic %></div>
            <!--
            <% if @library.active %>
              <div class="cl-item" style="margin-top:8px;">Knihovna je <Strong>aktivní</Strong></div>
            <% else %>
              <div class="cl-item" style="margin-top:8px;">Knihovna je <Strong>zrušena</Strong></div>
            <% end %>
            -->
          </div>
        </div>
        <div class="cl-category">      
          <div class="cl-title">Webové stránky</div>
          <div class="cl-items">
            <% @library.websites.order(:id).each do |website| %>
              <div class="cl-item">
                <%= website.url %> 
                <% if website.note %> 
                  (<%= website.note %>)
                <% end %>
              </div>
            <% end %>
          </div>
        </div>  
      </div>


    </div>


  </div>
</div>
</div>


<script type="text/javascript">  
$('#myTabs a').click(function (e) {
  e.preventDefault()
  $(this).tab('show')
});
</script>



<% unless @library.latitude.nil? || @library.longitude.nil? %>
<script type="text/javascript">  

  function addLibrary(map, myLatlng, bounds) {
    var contentString = '<div id="content" class="cl-marker-info">'+      
          '<div class="cl-title"><%= @library.name %></div>'+
          '<div class="cl-subtitle"><%= @library.street %>, <%= @library.zip %> <%= @library.city %></div>'+
          '</div>';

    var infowindow = new google.maps.InfoWindow({
        content: contentString
    });

    var marker = new google.maps.Marker({
      position: myLatlng,
      map: map,
      icon: "<%= asset_path 'ic_pin_library.png' %>",
      animation: google.maps.Animation.DROP,
      zIndex:99999999,
      title: '<%= @library.name%>'
    });

    bounds.extend(marker.getPosition());

    google.maps.event.addListener(marker, 'click', function() {
      infowindow.open(map,marker);
    });
  }

  function addBranches(map, bounds) {
    var branches = [];
    <% @library.branches.each_with_index do |branch, index| %>    
      <% unless branch.latitude.nil? || branch.longitude.nil? %>
        branches.push({lat:<%= branch.latitude%>, lon:<%= branch.longitude %>, name:'<%= branch.name %>', address:'<%= branch.address %>'});
      <% end %>
    <% end %>

    for(var i = 0; i < branches.length; i++) {
      var branch = branches[i];
      var marker = new google.maps.Marker({
        position: new google.maps.LatLng (branch.lat, branch.lon),
        icon: "<%= asset_path 'ic_pin_branch.png' %>",
        map: map,
        title: branch.title
      }); 
      bounds.extend(marker.getPosition());

      var contentString = '<div id="content" class="cl-marker-info">'+      
        '<div class="cl-title">pobočka ' + branch.name  + '</div>'+
        '<div class="cl-subtitle">' + branch.address  + '</div>'+
        '</div>';

      var infoWindow = new google.maps.InfoWindow();

      google.maps.event.addListener(marker, 'click', (function(marker, content) {
        return function() {       
          infoWindow.setContent(content);
          infoWindow.open(map, marker);
        }
      })(marker, contentString));      
    }
  }

  function initialize() {
    var myLatlng = new google.maps.LatLng(<%= @library.latitude%>, <%= @library.longitude%>);
    var mapOptions = {
      zoom: 10,
      center: myLatlng
    }
    var bounds = new google.maps.LatLngBounds();  
    var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    addBranches(map, bounds);
    addLibrary(map, myLatlng, bounds);    
    
    google.maps.event.addListenerOnce(map, 'bounds_changed', function(event) {
      if (this.getZoom() > 15) {
        this.setZoom(15);
      } else if(this.getZoom() < 7) {
        this.setZoom(7);
      }
    });
    map.fitBounds(bounds);    
  }
  initialize();
</script>
<% end %>